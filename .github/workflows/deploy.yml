name: Deploy ODSA

on:
  workflow_dispatch:
    inputs:
      deploy_server:
        description: Deploy API server to the Google VM
        type: boolean
        default: true
      deploy_mobile:
        description: Build and submit iOS/Android with EAS
        type: boolean
        default: true

jobs:
  deploy_server:
    if: ${{ inputs.deploy_server }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: ssh-keyscan -p ${{ secrets.GCP_SSH_PORT || '22' }} -H ${{ secrets.GCP_SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy server on Google VM
        timeout-minutes: 45
        run: |
          set -e
          ssh -o ServerAliveInterval=20 -o ServerAliveCountMax=6 -p ${{ secrets.GCP_SSH_PORT || '22' }} ${{ secrets.GCP_SSH_USER }}@${{ secrets.GCP_SSH_HOST }} <<'EOF'
          set -e
          git config --global --add safe.directory /opt/odsa_app
          cd /opt/odsa_app
          git pull
          pkill -f "node /opt/odsa_app/server/dist/index.js" || true
          cd /opt/odsa_app/server
          npm install
          npm run build
          if command -v pm2 >/dev/null 2>&1; then
            pm2 restart odsa-server
          else
            nohup npm start >/tmp/odsa_server.log 2>&1 &
          fi
          EOF

  deploy_mobile:
    if: ${{ inputs.deploy_mobile }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: mobile/package-lock.json

      - name: Set up Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install mobile dependencies
        working-directory: mobile
        run: npm ci

      - name: Build and submit iOS
        working-directory: mobile
        run: |
          eas build -p ios --profile production --non-interactive
          eas submit -p ios --latest --non-interactive --asc-app-id ${{ secrets.EXPO_ASC_APP_ID }}

      - name: Build and submit Android
        working-directory: mobile
        run: |
          eas build -p android --profile production --non-interactive
          eas submit -p android --latest --non-interactive
